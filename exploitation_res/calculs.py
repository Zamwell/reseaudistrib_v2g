# -*- coding: utf-8 -*-
"""
Created on Wed Sep 25 18:49:19 2019

@author: Utilisateur
"""

import os
import pandas as pd
from matplotlib import pyplot as plt
import numpy as np

def calc_pertes(output_dir):
    table_file = os.path.join(output_dir, "res_line", "pl_mw.csv")
    df = pd.read_csv(table_file, index_col = [0], sep = ";")
    df = df/4
    df_sum = pd.DataFrame()
    df_sum['Pertes'] = df.sum(axis=1)
    return df_sum

def calc_ecart_tension(output_dir,drop=[]):
    volt_table = os.path.join(output_dir, "res_bus", "vm_pu.csv")
    drop = [str(x) for x in drop]
    df = pd.read_csv(volt_table, index_col = [0], sep = ";")
    dfi = df.drop(drop, axis = 1)
    dfi = dfi.applymap(lambda x : (0.95 - x)**2 if x < 0.95 else ((x-1.05)**2 if x > 1.05 else 0))
    ecart = dfi.to_numpy().sum()
    return ecart

def calc_batterie_eq(output_dir, net_storage):
    table_soc = os.path.join(output_dir, 'storage', 'soc_percent.csv')
    table_inserv = os.path.join(output_dir, 'storage', 'in_service.csv')
    df_bat_eq = pd.DataFrame()
    df = pd.read_csv(table_soc, index_col=[0], sep = ";")
    df_inserv = pd.read_csv(table_inserv, index_col=[0], sep = ";")
    for bus in net_storage.bus.unique():
        drop = net_storage[net_storage.bus != bus].index.values
        drop_str = [str(nom) for nom in drop]
        dfi = df.drop(drop_str, axis = 1)
        dfi_inserv = df_inserv.drop(drop_str, axis = 1)
        df_tu = pd.DataFrame(np.rec.fromarrays((dfi.values, dfi_inserv.values)).tolist(),
                             columns = dfi.columns, index = dfi.index)
        df_som_inserv = df_tu.applymap(lambda tu : tu[0] if tu[1] else 0)
        df_bat_eq[str(bus)] = df_som_inserv.sum(axis = 1) * 0.05
    return df_bat_eq